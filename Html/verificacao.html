<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verificação de Aluno</title>
  </head>
  <a href="login.html" class="icon" onclick="pararVerificacao()">
    <img src="../imagens/iconvoltar.svg" alt="Voltar" class="icon" />
  </a>
  <body>
    <p>BioID - Bons Estudos</p>
    <p id="dataHora">BioID - 17/11/2025 08:24:58</p>
    <div class="container">
      <div id="statusDiv"></div>
      <div id="ImgDiv"></div>
      <div id="nomeDiv"></div>
      <div id="rmDiv"></div>
    </div>
    <script>
      const statusDiv = document.getElementById("statusDiv");
      let horaAtualLocal = null; // vai guardar a hora vindo da local
      function atualizarDataHora() {
        const dateTime = new Date();
        horaAtualLocal = dateTime;

        const dataBR = dateTime.toLocaleDateString("pt-BR");
        const horaBR = dateTime.toLocaleTimeString("pt-BR");

        document.getElementById(
          "dataHora"
        ).textContent = `BioID - ${dataBR} ${horaBR}`;
      }

      setInterval(atualizarDataHora, 1000);
      atualizarDataHora();

      pararVerificacao = () => {
        window.electronAPI.sendToMain({ action: "parar_verificacao" });
      };

      const nomeDiv = document.getElementById("nomeDiv");

      window.electronAPI.onEsp32Msg(async (msg) => {
        if (msg.acao === "verificacao_ok") {
          const slot = msg.slot;

          // Requisita o PHP para pegar nome do aluno
          try {
            const formData = new FormData();
            formData.append("slot", slot);

            const response = await fetch(
              "http://localhost/ETEC/3MIN/TCC/bioid/Php/validar.php",
              {
                method: "POST",
                body: formData,
              }
            );

            const data = await response.json();

            if (data.status === "sucesso") {
              //Função para atualizar o tipo de entrada do aluno
              const hora = horaAtualLocal.getHours();
              const minuto = horaAtualLocal.getMinutes();
              const minutosAgora = hora * 60 + minuto;
              const diaSemana = horaAtualLocal.getDay(); // 0 (Domingo) a 6 (Sábado)

              try {
                const formDataAtt = new FormData();
                formDataAtt.append("rm", data.rm);
                formDataAtt.append("minutosAgora", minutosAgora);
                formDataAtt.append("diaSemana", diaSemana);
                const respAtt = await fetch(
                  "http://localhost/ETEC/3MIN/TCC/bioid/Php/entradaAtt.php",
                  {
                    method: "POST",
                    body: formDataAtt,
                  }
                );
                const resultado = await respAtt.json();

                if (resultado.status === "sucesso") {
                  console.log("Entrada atualizada com sucesso!");
                  console.log("Status do aluno:", resultado.statusAluno);
                  console.log("Mensagem:", resultado.mensagem);

                  // EXEMPLOS DE USO:
                  statusDiv.textContent = resultado.mensagem;
                } else {
                  console.warn("Erro no PHP:", resultado.mensagem);
                  statusDiv.textContent = "Erro: " + resultado.mensagem;
                }
              } catch (error) {
                console.error("Erro ao atualizar entrada do aluno:", error);
              }

              const imgPath = `../imagens/img_alunos/${data.rm}.png`; // ou .png dependendo do formato

              ImgDiv.innerHTML = `<img src="${imgPath}" alt="Foto do aluno" style="width:150px;border-radius:10px;">`;
              nomeDiv.textContent = `Aluno: ${data.nome_aluno}`;
              rmDiv.textContent = `RM: ${data.rm}`;

              setTimeout(() => {
                ImgDiv.innerHTML = "";
                nomeDiv.textContent = "";
                rmDiv.textContent = "";
                statusDiv.textContent = "";
              }, 3000);
              console.log();
            } else {
              nomeDiv.textContent = `Aluno não encontrado`;
            }
          } catch (err) {
            console.error("Erro ao buscar nome do aluno:", err);
            nomeDiv.textContent = "Erro na busca";
          }
        }
      });
    </script>
    <!-- <link rel="stylesheet" href="../css/varificacao.css"> -->
  </body>
</html>
